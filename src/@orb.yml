version: 2.1

description: >
  Reconstruct $CIRCLE_COMPARE_URL env var, for working with monorepos

examples:
  simple-monorepo-flow:
    description: >
      Execute some action only for modified files from this commit

      This example presupposes a monorepo of orbs,
      of which we only want to publish those with modifications

      See https://discuss.circleci.com/t/does-circleci-2-0-work-with-monorepos
      for details
    usage:
      version: 2.1

      orbs:
        compare-url: iynere/compare-url@volatile

      workflows:
        version: 2
        publish-orbs:
          jobs:
            - publish

      jobs:
        publish:
          docker:
            - image: circleci/circleci-cli
          steps:
            - checkout
            - compare-url/reconstruct
            - run:
                name: Publish modified orbs
                shell: /bin/bash -exo pipefail
                command: |
                  # save value stored in file to a local env var
                  CIRCLE_COMPARE_URL=$(cat CIRCLE_COMPARE_URL)

                  COMMIT_RANGE=$(echo $CIRCLE_COMPARE_URL | sed 's:^.*/compare/::g')

                  echo "Commit range: $COMMIT_RANGE"

                  for ORB in folder-containing-orb-subdirs/*/; do

                    orbname=$(basename $ORB)

                    if [[ $(git diff $COMMIT_RANGE --name-status | grep "$orbname") ]]; then

                      echo "publishing ${orbname}"

                      circleci orb publish ${ORB}/orb.yml namespace/${orbname}@version
                    else
                      echo "${orbname} not modified; no need to publish"
                    fi
                  done

commands:
  reconstruct:
    description: >
      Reconstruct CIRCLE_COMPARE_URL, output it to an eponymous file

    parameters:
      circle-token:
        description: >
          Your CircleCI API token, defaults to $CIRCLE_TOKEN
        type: string
        default: $CIRCLE_TOKEN

    steps:
      - run:
          name: Reconstruct CIRCLE_COMPARE_URL
          command: |
            RETRY=true
            JOB_NUM=$CIRCLE_PREVIOUS_BUILD_NUM

            while [[ $(echo $RETRY) == true ]]
            do
              if [[ $(curl --user $CIRCLE_TOKEN: \
                https://circleci.com/api/v1.1/project/github/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/$JOB_NUM | \
                grep '"retry_of" : null') && ! $(curl --user $CIRCLE_TOKEN: \
                https://circleci.com/api/v1.1/project/github/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/$JOB_NUM | \
                grep '"workflow_id" : "$CIRCLE_WORKFLOW_ID"')]]; then

                RETRY=false
              else
                echo "$JOB_NUM was a retry of a previous job, or part of the current workflow"
                JOB_NUM=$(( $JOB_NUM - 1 ))
              fi
            done

            LAST_PUSHED_COMMIT=$(curl --user $CIRCLE_TOKEN: \
              https://circleci.com/api/v1.1/project/github/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/$JOB_NUM | \
              grep '"commit" : ' | sed -E 's/"commit" ://' | sed -E 's/[[:punct:]]//g' | sed -E 's/ //g')

            echo "last pushed commit hash is:" $LAST_PUSHED_COMMIT

            echo "- - - - - - - - - - - - - - - - - - - - - - - -"

            echo "this job's commit hash is:" $CIRCLE_SHA1

            echo "- - - - - - - - - - - - - - - - - - - - - - - -"

            echo "recreated CIRCLE_COMPARE_URL: \
              https://github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/compare/${LAST_PUSHED_COMMIT:0:12}...${CIRCLE_SHA1:0:12}"

            echo "- - - - - - - - - - - - - - - - - - - - - - - -"

            echo "outputting CIRCLE_COMPARE_URL to a file in your working directory, called CIRCLE_COMPARE_URL"

            echo "https://github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/compare/${LAST_PUSHED_COMMIT:0:12}...${CIRCLE_SHA1:0:12}" \
              > CIRCLE_COMPARE_URL
